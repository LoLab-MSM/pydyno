<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <style type="text/css">
        body {
            font: 14px helvetica neue, helvetica, arial, sans-serif;
        }

        ul li {
            background: #ffe5e5;
            padding: 5px;
        }

        .tooltiptext{
            display: none;
        }

        .input-color {
            position: relative;
        }
        .input-color input {
            padding-left: 20px;
        }
        .input-color .color-box {
            width: 10px;
            height: 10px;
            display: inline-block;
            background-color: #ccc;
            position: absolute;
            left: 5px;
            top: 8px;
        }

        #{{uuid}} {
            height: {{widget_height}}px;
            width: {{widget_width}}%;
            position: absolute;
            left: 4px;
            top: 5px;
            background: {{background}};
        }
        #{{playid}} {
            width: 5%;
            height: 4%;
            font-size:130%;
            position: absolute;
            top: 93%;
            left: 10%;
        }

        #{{resetid}} {
            width: 7%;
            height: 4%;
            font-size:130%;
            position: absolute;
            top: 93%;
            left: 16%;
        }

        #{{rangeid}} {
            width:80%;
            height:25px;
            top:89%;
            left:10%;
            border:1px solid black;
            position:absolute;
        }

        #{{textid}} {
            width:10%;
            height:5%;
            top:92.5%;
            left:24%;
            font-size:120%;
            border:0px solid black;
            position:absolute;
        }
        #{{fitbutton}} {
            width: 3em;
            margin: 0.5em;
            position: absolute;
            z-index: 999;
            top: 0;
            right: 0;
        }

        #{{fitbutton}} i {
            transform: rotate(45deg);
        }

    </style>

    <script>
        (function() {
            var all_data ={{datos}};
            function render() {

                var cy = window.cy = cytoscape({
                    container: $('#{{uuid}}'),
                    style: cytoscape.stylesheet()
                        .selector('node')
                        .style({
                            'label': 'data(label)',
                            'pie-size': '80%',
                            'pie-1-background-color': 'data(background_color)',
                            'pie-1-background-size': '100',
                            'pie-2-background-color': '#dddcd4',
                            'pie-2-background-size': '100'
                        })

                        .selector('edge')
                        .style({
                            'curve-style': 'bezier',
                            // 'width': 'data(width)',
                            'target-arrow-shape': 'data(target_arrow_shape)',
                            'source-arrow-shape': 'data(source_arrow_shape)'
                        }),
                    elements: all_data.elements,

                    layout: {name: '{{layout}}'
                    },

                    boxSelectionEnabled: true
                });

                cy.on('tap', function(evt){
                    var ele = evt.target;
                    if (ele.data()['tip']['state']['visible']){
                        ele.data()['tip'].hide();
                    } else {
                        ele.data()['tip'].show();
                    }
                });

                var makeTippy = function(target, text){
                    return tippy( target.popperRef(), {
                        html: (function(){
                            var div = document.createElement('div');
                            div.innerHTML = text;
//                            $('#{{uuid}}')[0].appendChild(div);
//                            console.log($('#{{uuid}}')[0]);
                            return div;
                        })(),
//                        appendTo: document.body,
//                        offset: '0, 450',
                        trigger: 'manual',
                        arrow: true,
                        placement: 'bottom',
                        hideOnClick: false,
                        interactive: true,
                        multiple: true,
                        sticky: true
                    } ).tooltips[0];
                };

                var dynamics_vis = function(){

                    var tspan = all_data.data.tspan;
                    var text = $('#{{textid}}')[0];
                    var rangeInput = $('#{{rangeid}}')[0];
                    rangeInput.max = tspan.length;

                    cy.edges().forEach(function(e){
                        e.data()['tip'] = makeTippy(e, '');
                    });

                    cy.nodes().forEach(function(n){
                        n.data()['tip'] = makeTippy(n, '');
                    });

                    function update_nodes(t){
                        rangeInput.value = t;
                        text.value = tspan[t].toFixed(2);

                        cy.batch(function(){
                            cy.edges().forEach(function (e) {
                                var c = e.data('edge_color')[t];
                                var s = e.data('edge_size')[t];
                                var a = e.data('edge_qtip')[t];
                                e.style({'line-color': c,
                                    'target-arrow-color': c,
                                    'source-arrow-color': c,
                                    'width': s});

                                // e.animate({
                                //     style: {'line-color': c,
                                //         'target-arrow-color': c,
                                //         'source-arrow-color': c,
                                //         'width': s},
                                //     duration: 100,
                                //     queue: false
                                // });

                                e.data()['tip']['popper'].querySelector('.tippy-content').textContent = a.toExponential(2).toString();
                                // n.animate({style: {'width': s}})

                            });
                            cy.nodes().forEach(function(n){
                                var p = n.data('rel_value')[t];
                                var q = n.data('abs_value')[t];
                                n.style({'pie-1-background-size': p});

                                // n.animate({
                                //     style: {'pie-1-background-size': p},
                                //     duration: 100,
                                //     queue: false
                                // });
                                n.data()['tip']['popper'].querySelector('.tippy-content').textContent = q.toExponential(2).toString();


                            });
                        });
                    }

                    var currentTime = 0;
                    var tInterval = null;

                    function nextTime(){
                        currentTime = currentTime+1;
                        if (currentTime >= tspan.length){
                            clearInterval(tInterval)
                        }
                        else {update_nodes(currentTime)}
                    }

                    var playing = false;
                    var playButton = $('#{{playid}}')[0];

                    function pauseSlideshow(){
                        playButton.innerHTML = 'Play';
                        playing = false;
                        clearInterval(tInterval);
                    }

                    function playSlideshow(){
                        playButton.innerHTML = 'Pause';
                        playing = true;
                        tInterval = setInterval(nextTime, 1000)
                    }


                    var resetButton = $('#{{resetid}}')[0];
                    resetButton.onclick = function(){
                        pauseSlideshow();
                        currentTime = 0;
                        update_nodes(currentTime)
                    };

                    playButton.onclick = function(){
                        if(playing){ pauseSlideshow(); }
                        else{ playSlideshow(); }
                    };
                    rangeInput.addEventListener('mouseup', function(){
                        pauseSlideshow();
                        currentTime = this.value;
                        currentTime = parseInt(currentTime);
                        update_nodes(currentTime);

                    });

                    rangeInput.onchange = function(){
                        text.value = tspan[this.value].toFixed(2);
                        // currentTime = this.value
                    };
                };

                var cluster_info = function () {

                    var divClone = $('#{{clusid}}').clone();
                    cy.batch(function () {
                        cy.nodes("[clus_colors]").forEach(function (n) {
                            var bg = n.data('clus_colors');
                            var perc = n.data('clus_perc');
                            var scores = n.data('clus_scores');
                            var repres = n.data('clus_repres');
                            var i;
                            var pie_bg = {};
                            for (i = 0; i < bg.length; i++){
                                pie_bg['pie-'+(i+1)+'-background-color'] = bg[i];
                                pie_bg['pie-'+(i+1)+'-background-size'] = perc[i];
                                var data = "";
                                data +="<li style='list-style: none;'>";
                                data +="<div class='input-color'> <input type='text' " +
                                    "value='"+ perc[i].toFixed(2) +" "+'%,'+" "+ repres[i] +"' /> <div " +
                                    "class='color-box' style='background-color:"+ bg[i] +";' </div></div>";
                                data +="</li>";
                                $('#{{clusid}}').append(data) ;

                            }
                            n.style(pie_bg);
//                            n.qtip('api').set('content.text', $('#{{clusid}}'));
//                            n.qtip('api').set('content.title', n.data('label')+', score: ' +scores[0].toFixed(2));
                            $('#{{clusid}}').replaceWith(divClone.clone());

                        })

                    });
                };

                var static_vis = function () {
                    $('#{{textid}}')[0].style.display = 'none';
                    $('#{{rangeid}}')[0].style.display = 'none';
                    $('#{{playid}}')[0].style.display = 'none';
                    $('#{{resetid}}')[0].style.display = 'none';
                };

                if(all_data.data.view === 'dynamic'){
                    dynamics_vis();
                } else {
                    static_vis();
                    cluster_info()
                }

                var allNodes;
                var layoutPadding = 50;
                var aniDur = 500;
                var easing = 'linear';
                allNodes = cy.nodes();
                $('#{{fitbutton}}').on('click', function(){

                    allNodes.unselect();
                    cy.stop();

                    cy.animation({
                        fit: {
                            eles: cy.elements(),
                            padding: layoutPadding
                        },
                        duration: aniDur,
                        easing: easing
                    }).play();

                });

            }

            var before_render = function(){
                if(window['cytoscape'] === undefined){
                    console.log("Waiting for Cyjs...");
                    window.addEventListener("load_cytoscape", before_render);
                } else {
                    console.log("Ready to render graph!");
                    render();
                }
            };

            before_render();

        })();
    </script>
</head>

<body>
<div id="{{uuid}}"></div>
<!-- When only #uuid div is placed on this page,
the height of output-box on ipynb will be 0px.
One line below will prevent that. -->
<button class="controls" id={{playid}}>Play</button>
<button class="controls" id={{resetid}}>Reset</button>
<input type="range" class="slider" id={{rangeid}} min="0" max="50" value="0" step="1">
<input type="text" size="400" id={{textid}} value="0">
<button id={{fitbutton}} class="btn btn-default"><i class="fa fa-arrows-h"></i></button>
<div id="dummy" style="width:{{widget_width}}px;height:{{widget_height}}px"></div>
<div class="tooltiptext" id="{{clusid}}"></div>
</body>

</html>
